---
import Layout from '../../layouts/Layout.astro';
import { renderMarkdown } from '../../utils/markdown';
import { SchedulerService } from '../../services/SchedulerService';
import { AstroSchedulerDBAdapter } from '../../services/SchedulerDBAdapter';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/editor');
}

const service = new SchedulerService(new AstroSchedulerDBAdapter());
let post;
try {
  post = await service.getById(id);
} catch {
  return Astro.redirect('/editor');
}

if (!post.generatedTitle || !post.generatedContent) {
  return Astro.redirect('/editor');
}

const htmlContent = await renderMarkdown(post.generatedContent);

const formattedScheduledDate = post.scheduledDate.toLocaleDateString('de-DE', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const tags = post.parsedTags;
---

<Layout title={`Vorschau: ${post.generatedTitle}`} description={post.generatedDescription || ''}>
  <article class="article-page">
    <!-- Preview Banner -->
    <div class="preview-banner">
      <span class="preview-badge">Vorschau</span>
      <span class="preview-info">
        Geplant für {formattedScheduledDate} &middot; Status: {post.status === 'generated' ? 'Generiert' : post.status}
      </span>
      <a href="/editor" class="preview-back">Zurück zum Editor</a>
    </div>

    <!-- Article Header -->
    <header class="article-header">
      <div class="article-header-content">
        <div class="article-meta">
          {tags[0] && <span class="article-category">{tags[0]}</span>}
          <span class="article-meta-divider" aria-hidden="true"></span>
          <time class="article-date">{formattedScheduledDate}</time>
        </div>
        <p class="article-lede">{post.generatedDescription}</p>
        {tags.length > 1 && (
          <div class="article-tags">
            {tags.slice(1).map((tag: string) => (
              <span class="article-tag">{tag}</span>
            ))}
          </div>
        )}
      </div>
    </header>

    <!-- Hero Image -->
    {post.generatedImageData && (
      <div class="preview-hero">
        <img
          src={`data:image/webp;base64,${post.generatedImageData}`}
          alt={post.generatedImageAlt || post.generatedTitle}
          class="preview-hero-img"
        />
      </div>
    )}

    <!-- Article Body -->
    <div class="article-body">
      <div class="content-column">
        <div class="article-content prose" set:html={htmlContent} />
      </div>

      <aside class="article-sidebar">
        <div class="sidebar-card">
          <h4 class="sidebar-title">Themen</h4>
          <div class="sidebar-tags">
            {tags.map((tag: string) => (
              <span class="sidebar-tag">{tag}</span>
            ))}
          </div>
        </div>
        <div class="sidebar-card">
          <h4 class="sidebar-title">Info</h4>
          <div class="sidebar-info">
            <div class="sidebar-info-row">
              <span class="sidebar-info-label">Input</span>
              <span class="sidebar-info-value">{post.input}</span>
            </div>
            <div class="sidebar-info-row">
              <span class="sidebar-info-label">Typ</span>
              <span class="sidebar-info-value">{post.inputType === 'url' ? 'URL' : 'Keywords'}</span>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <footer class="article-footer">
      <a href="/editor" class="back-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        <span>Zurück zum Editor</span>
      </a>
    </footer>
  </article>
</Layout>

<style>
  .preview-banner {
    display: flex;
    align-items: center;
    gap: var(--space-4, 1rem);
    padding: var(--space-4, 1rem) var(--space-6, 1.5rem);
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: var(--radius-md, 8px);
    margin-bottom: var(--space-8, 2rem);
    margin-top: var(--space-8, 2rem);
    flex-wrap: wrap;
  }

  .preview-badge {
    font-family: var(--font-ui, system-ui);
    font-size: var(--text-xs, 0.75rem);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #f59e0b;
    background: rgba(245, 158, 11, 0.15);
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .preview-info {
    font-size: var(--text-sm, 0.875rem);
    color: var(--color-text-muted, #9a9590);
  }

  .preview-back {
    margin-left: auto;
    font-size: var(--text-sm, 0.875rem);
    color: var(--color-primary, #e63946);
    text-decoration: none;
    font-weight: 600;
  }

  .preview-back:hover {
    text-decoration: underline;
  }

  .preview-hero {
    margin-bottom: var(--space-10, 2.5rem);
    border-radius: var(--radius-lg, 12px);
    overflow: hidden;
  }

  .preview-hero-img {
    width: 100%;
    max-height: 480px;
    object-fit: cover;
    display: block;
  }

  /* Reuse article page styles */
  .article-page {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: 0 var(--gutter);
  }

  .article-header {
    padding: var(--space-8, 2rem) 0 var(--space-8, 2rem);
    max-width: 900px;
  }

  .article-header-content {
    opacity: 1;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-4, 1rem);
    margin-bottom: var(--space-6, 1.5rem);
  }

  .article-category {
    font-family: var(--font-ui);
    font-size: var(--text-xs, 0.75rem);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest, 0.1em);
    color: var(--color-primary);
    padding: var(--space-1, 0.25rem) var(--space-3, 0.75rem);
    background: var(--color-primary-muted);
    border-radius: var(--radius-sm, 4px);
  }

  .article-meta-divider {
    width: 32px;
    height: 1px;
    background: var(--color-border-accent);
  }

  .article-date {
    font-family: var(--font-ui);
    font-size: var(--text-sm, 0.875rem);
    color: var(--color-text-muted);
  }

  .article-lede {
    font-family: var(--font-body);
    font-size: var(--text-xl, 1.25rem);
    color: var(--color-text-secondary);
    line-height: var(--leading-relaxed, 1.625);
    max-width: 720px;
    margin-bottom: var(--space-6, 1.5rem);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2, 0.5rem);
  }

  .article-tag {
    font-family: var(--font-ui);
    font-size: var(--text-xs, 0.75rem);
    color: var(--color-text-muted);
    background: var(--color-surface-elevated);
    padding: var(--space-1, 0.25rem) var(--space-3, 0.75rem);
    border-radius: var(--radius-full, 9999px);
  }

  .article-body {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 280px;
    gap: var(--space-16, 4rem);
    max-width: 1100px;
  }

  .content-column {
    min-width: 0;
    overflow: hidden;
  }

  .prose {
    font-family: var(--font-body);
    font-size: var(--text-lg, 1.125rem);
    line-height: var(--leading-loose, 2);
    color: var(--color-text-accent);
    max-width: 100%;
    overflow-wrap: break-word;
  }

  .prose :global(> p:first-of-type::first-letter) {
    font-family: var(--font-display);
    font-size: 4.5em;
    font-weight: 700;
    float: left;
    line-height: 0.75;
    padding-right: var(--space-4, 1rem);
    padding-top: var(--space-2, 0.5rem);
    color: var(--color-primary);
  }

  .prose :global(h1) {
    font-family: var(--font-display);
    font-size: clamp(var(--text-4xl, 2.25rem), 5vw, var(--text-6xl, 3.75rem));
    font-weight: 700;
    line-height: var(--leading-tight, 1.25);
    letter-spacing: var(--tracking-tighter, -0.04em);
    margin-bottom: var(--space-8, 2rem);
    color: var(--color-text);
  }

  .prose :global(h2) {
    font-family: var(--font-display);
    font-size: var(--text-3xl, 1.875rem);
    font-weight: 600;
    line-height: var(--leading-snug, 1.375);
    margin-top: var(--space-14, 3.5rem);
    margin-bottom: var(--space-6, 1.5rem);
    color: var(--color-text);
  }

  .prose :global(h3) {
    font-family: var(--font-display);
    font-size: var(--text-2xl, 1.5rem);
    font-weight: 600;
    margin-top: var(--space-10, 2.5rem);
    margin-bottom: var(--space-4, 1rem);
    color: var(--color-text);
  }

  .prose :global(p) { margin-bottom: var(--space-6, 1.5rem); }
  .prose :global(strong) { font-weight: 600; color: var(--color-text); }
  .prose :global(em) { font-style: italic; }

  .prose :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-6, 1.5rem);
    padding-left: var(--space-6, 1.5rem);
  }

  .prose :global(li) { margin-bottom: var(--space-3, 0.75rem); }
  .prose :global(li::marker) { color: var(--color-primary); }

  .prose :global(code) {
    font-family: var(--font-mono);
    font-size: 0.9em;
  }

  .prose :global(p code),
  .prose :global(li code) {
    background: var(--color-surface-elevated);
    padding: var(--space-1, 0.25rem) var(--space-2, 0.5rem);
    border-radius: var(--radius-sm, 4px);
    color: var(--color-accent);
  }

  .prose :global(pre) {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md, 8px);
    padding: var(--space-6, 1.5rem);
    margin: var(--space-8, 2rem) 0;
    overflow-x: auto;
  }

  .prose :global(pre code) {
    background: transparent;
    padding: 0;
    color: var(--color-text-accent);
    font-size: var(--text-sm, 0.875rem);
    white-space: pre;
    display: block;
  }

  .prose :global(blockquote) {
    margin: var(--space-10, 2.5rem) 0;
    padding: var(--space-6, 1.5rem) var(--space-8, 2rem);
    background: var(--color-surface);
    border-left: 4px solid var(--color-primary);
    border-radius: 0 var(--radius-md, 8px) var(--radius-md, 8px) 0;
  }

  .prose :global(blockquote p) {
    font-style: italic;
    font-size: var(--text-xl, 1.25rem);
    color: var(--color-text-secondary);
    margin-bottom: 0;
  }

  .article-sidebar {
    position: sticky;
    top: calc(var(--header-height, 64px) + var(--space-8, 2rem));
    height: fit-content;
    display: flex;
    flex-direction: column;
    gap: var(--space-6, 1.5rem);
  }

  .sidebar-card {
    background: var(--color-surface);
    border-radius: var(--radius-lg, 12px);
    padding: var(--space-6, 1.5rem);
    border: 1px solid var(--color-border-subtle);
  }

  .sidebar-title {
    font-family: var(--font-ui);
    font-size: var(--text-xs, 0.75rem);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest, 0.1em);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4, 1rem);
  }

  .sidebar-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2, 0.5rem);
  }

  .sidebar-tag {
    font-family: var(--font-ui);
    font-size: var(--text-xs, 0.75rem);
    color: var(--color-text-secondary);
    background: var(--color-surface-elevated);
    padding: var(--space-1, 0.25rem) var(--space-3, 0.75rem);
    border-radius: var(--radius-full, 9999px);
  }

  .sidebar-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-3, 0.75rem);
  }

  .sidebar-info-row {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  .sidebar-info-label {
    font-size: var(--text-xs, 0.75rem);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
  }

  .sidebar-info-value {
    font-size: var(--text-sm, 0.875rem);
    color: var(--color-text-accent);
    word-break: break-all;
  }

  .article-footer {
    max-width: 1100px;
    margin-top: var(--space-16, 4rem);
    padding: var(--space-8, 2rem) 0 var(--space-20, 5rem);
    border-top: 1px solid var(--color-border);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3, 0.75rem);
    color: var(--color-text-secondary);
    text-decoration: none;
    font-family: var(--font-ui);
    font-size: var(--text-sm, 0.875rem);
    font-weight: 500;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .back-link:hover svg {
    transform: translateX(-4px);
  }

  .back-link svg {
    transition: transform 0.2s;
  }

  @media (max-width: 1024px) {
    .article-body {
      grid-template-columns: 1fr;
      gap: var(--space-10, 2.5rem);
    }
    .article-sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
    }
    .sidebar-card {
      flex: 1;
      min-width: 200px;
    }
  }

  @media (max-width: 768px) {
    .prose { font-size: var(--text-base, 1rem); }
    .prose :global(> p:first-of-type::first-letter) { font-size: 3.5em; }
    .prose :global(h1) { font-size: var(--text-3xl, 1.875rem); }
    .prose :global(h2) { font-size: var(--text-2xl, 1.5rem); }
    .preview-banner { flex-direction: column; align-items: flex-start; }
    .preview-back { margin-left: 0; }
  }
</style>
