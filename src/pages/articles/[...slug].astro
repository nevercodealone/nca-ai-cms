---
import Layout from '../../layouts/Layout.astro';
import { renderMarkdown } from '../../utils/markdown';
import { escapeJsonLd } from '../../utils/sanitize';
import HeroImage from '../../components/HeroImage.astro';
import { ArticleService } from '../../services/ArticleService';

// Check if user is authenticated
const authCookie = Astro.cookies.get('editor-auth');
const isAuthenticated = !!authCookie?.value;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Extract just the slug (last part of the path)
const articleSlug = slug.split('/').pop() || slug;

const service = new ArticleService();
const article = await service.read(articleSlug);

if (!article) {
  return Astro.redirect('/');
}

// Render markdown to HTML
const htmlContent = await renderMarkdown(article.content || '');

// Format the date nicely
const formattedDate = article.date.toLocaleDateString('de-DE', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const siteUrl = (Astro.site ?? new URL(Astro.url.origin))
  .toString()
  .replace(/\/+$/, '');
const articleUrl = `${siteUrl}/articles/${slug}`;
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: article.title,
  description: article.description,
  datePublished: article.date.toISOString(),
  url: articleUrl,
  inLanguage: 'de',
  publisher: {
    '@type': 'Organization',
    name: 'NCA Content',
    url: siteUrl,
  },
  ...(article.image
    ? { image: `${siteUrl}/api/article-image/${slug}/hero.webp` }
    : {}),
  ...(article.tags?.length ? { keywords: article.tags.join(', ') } : {}),
};
---

<Layout title={article.title} description={article.description}>
  <script
    type="application/ld+json"
    set:html={escapeJsonLd(JSON.stringify(jsonLd))}
  />
  <article class="article-page">
    <!-- Article Header -->
    <header class="article-header" data-article-id={articleSlug}>
      <div class="article-header-content animate-fadeInUp">
        <div class="article-meta">
          <span class="article-category">{article.tags[0]}</span>
          <span class="article-meta-divider" aria-hidden="true"></span>
          <time datetime={article.date.toISOString()} class="article-date">
            {formattedDate}
          </time>
        </div>
        <p class="article-lede">{article.description}</p>
        {
          article.tags.length > 1 && (
            <div class="article-tags">
              {article.tags.slice(1).map((tag: string) => (
                <span class="article-tag">{tag}</span>
              ))}
            </div>
          )
        }
      </div>
    </header>

    <!-- Hero Image -->
    {
      article.image && (
        <HeroImage
          articleId={article.articleId}
          alt={article.imageAlt || article.title}
          isAuthenticated={isAuthenticated}
        />
      )
    }

    <!-- Article Body -->
    <div class="article-body">
      <div class="content-column" data-article-id={articleSlug}>
        {
          isAuthenticated && (
            <div class="content-actions">
              <button
                class="regenerate-text-icon"
                type="button"
                aria-label="Text neu generieren"
              >
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M23 4v6h-6" />
                  <path d="M1 20v-6h6" />
                  <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                </svg>
              </button>
              <button
                class="apply-text-btn"
                type="button"
                hidden
                aria-label="Speichern"
              >
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="3"
                >
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              </button>
            </div>
          )
        }
        <div class="article-content prose" set:html={htmlContent} />
        <div class="content-preview prose" hidden></div>
      </div>

      <!-- Sidebar -->
      <aside class="article-sidebar">
        <div class="sidebar-card">
          <h4 class="sidebar-title">Themen</h4>
          <div class="sidebar-tags">
            {
              article.tags.map((tag: string) => (
                <span class="sidebar-tag">{tag}</span>
              ))
            }
          </div>
        </div>
      </aside>
    </div>

    <!-- Article Footer -->
    <footer class="article-footer">
      <a href="/" class="back-link">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
        <span>Zurück zur Übersicht</span>
      </a>
    </footer>
  </article>
</Layout>

<script>
  const contentColumn = document.querySelector(
    '.content-column'
  ) as HTMLElement;
  if (contentColumn) {
    const articleId = contentColumn.dataset.articleId;
    const regenerateBtn = contentColumn.querySelector(
      '.regenerate-text-icon'
    ) as HTMLButtonElement;
    const contentDiv = contentColumn.querySelector(
      '.article-content'
    ) as HTMLElement;
    const previewDiv = contentColumn.querySelector(
      '.content-preview'
    ) as HTMLElement;
    const applyBtn = contentColumn.querySelector(
      '.apply-text-btn'
    ) as HTMLButtonElement;

    let previewData: {
      title: string;
      description: string;
      content: string;
    } | null = null;

    const escapeForPreview = (str: string): string => {
      const el = document.createElement('span');
      el.textContent = str;
      return el.innerHTML;
    };

    const showPreview = (html: string) => {
      previewDiv.innerHTML = html;
      contentDiv.hidden = true;
      previewDiv.hidden = false;
      applyBtn.hidden = false;
      regenerateBtn.hidden = true;
    };

    const generateText = async () => {
      regenerateBtn.disabled = true;
      regenerateBtn.classList.add('loading');
      try {
        const res = await fetch(`/api/articles/${articleId}/regenerate-text`, {
          method: 'POST',
        });
        if (!res.ok) throw new Error('Generation failed');
        const data = await res.json();
        previewData = {
          title: data.title,
          description: data.description,
          content: data.content,
        };
        showPreview(
          `<h1>${escapeForPreview(data.title)}</h1><p><em>${escapeForPreview(data.description)}</em></p>${escapeForPreview(data.content.replace(/^#\s+.+\n/, ''))}`
        );
      } catch {
        alert('Text-Generierung fehlgeschlagen');
        regenerateBtn.disabled = false;
        regenerateBtn.classList.remove('loading');
      }
    };

    const applyChanges = async () => {
      if (!previewData) return;
      applyBtn.disabled = true;
      applyBtn.classList.add('loading');
      try {
        const res = await fetch(`/api/articles/${articleId}/apply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(previewData),
        });
        if (!res.ok) throw new Error('Save failed');
        window.location.reload();
      } catch {
        alert('Speichern fehlgeschlagen');
        applyBtn.disabled = false;
        applyBtn.classList.remove('loading');
      }
    };

    regenerateBtn?.addEventListener('click', generateText);
    applyBtn?.addEventListener('click', applyChanges);
  }

  document.querySelectorAll('.prose pre').forEach((pre) => {
    pre.setAttribute('tabindex', '0');
    pre.setAttribute('role', 'region');
    pre.setAttribute('aria-label', 'Codeblock');
  });
</script>

<style>
  [hidden] {
    display: none !important;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     ARTICLE PAGE LAYOUT
     ═══════════════════════════════════════════════════════════════════════════ */

  .article-page {
    max-width: var(--container-max);
    margin: 0 auto;
    padding: 0 var(--gutter);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     ARTICLE HEADER
     ═══════════════════════════════════════════════════════════════════════════ */

  .article-header {
    padding: var(--space-16) 0 var(--space-12);
    max-width: 900px;
  }

  .article-header-content {
    opacity: 0;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .article-category {
    font-family: var(--font-ui);
    font-size: var(--text-base);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest);
    color: var(--color-text);
    padding: var(--space-1) var(--space-3);
    background: var(--color-primary-muted);
    border-radius: var(--radius-sm);
  }

  .article-meta-divider {
    width: 32px;
    height: 1px;
    background: var(--color-border-accent);
  }

  .article-date {
    font-family: var(--font-ui);
    font-size: var(--text-sm);
    color: var(--color-text);
  }

  .article-lede {
    font-family: var(--font-body);
    font-size: var(--text-xl);
    color: var(--color-text);
    line-height: var(--leading-relaxed);
    max-width: 720px;
    margin-bottom: var(--space-6);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .article-tag {
    font-family: var(--font-ui);
    font-size: var(--text-base);
    color: var(--color-text);
    background: var(--color-surface-elevated);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     ARTICLE BODY - Two Column Layout
     ═══════════════════════════════════════════════════════════════════════════ */

  .article-body {
    display: grid;
    grid-template-columns: minmax(0, 1fr) 280px;
    gap: var(--space-16);
    max-width: 1100px;
  }

  .content-column {
    min-width: 0;
    overflow: hidden;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     PROSE STYLES - Magazine Typography
     ═══════════════════════════════════════════════════════════════════════════ */

  .prose {
    font-family: var(--font-body);
    font-size: var(--text-lg);
    line-height: var(--leading-loose);
    color: var(--color-text-accent);
    max-width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
  }

  /* Drop Cap - First letter of first paragraph */
  .prose :global(> p:first-of-type::first-letter) {
    font-family: var(--font-display);
    font-size: 4.5em;
    font-weight: 700;
    float: left;
    line-height: 0.75;
    padding-right: var(--space-4);
    padding-top: var(--space-2);
    color: var(--color-primary);
  }

  /* Headings */
  .prose :global(h1) {
    font-family: var(--font-display);
    font-size: clamp(var(--text-4xl), 5vw, var(--text-6xl));
    font-weight: 700;
    line-height: var(--leading-tight);
    letter-spacing: var(--tracking-tighter);
    margin-bottom: var(--space-8);
    color: var(--color-text);
  }

  .prose :global(h2) {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 600;
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-tight);
    margin-top: var(--space-14);
    margin-bottom: var(--space-6);
    color: var(--color-text);
  }

  .prose :global(h3) {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 600;
    line-height: var(--leading-snug);
    margin-top: var(--space-10);
    margin-bottom: var(--space-4);
    color: var(--color-text);
  }

  .prose :global(h4) {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 600;
    margin-top: var(--space-8);
    margin-bottom: var(--space-3);
    color: var(--color-text);
  }

  /* Paragraphs */
  .prose :global(p) {
    margin-bottom: var(--space-6);
  }

  /* Strong/Bold */
  .prose :global(strong) {
    font-weight: 600;
    color: var(--color-text);
  }

  /* Emphasis/Italic */
  .prose :global(em) {
    font-style: italic;
  }

  /* Links */
  .prose :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
    transition:
      color var(--transition-fast),
      text-decoration-color var(--transition-fast);
  }

  .prose :global(a:hover) {
    color: var(--color-accent);
  }

  /* Lists */
  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--space-6);
    padding-left: var(--space-6);
  }

  .prose :global(li) {
    margin-bottom: var(--space-3);
    padding-left: var(--space-2);
  }

  .prose :global(li::marker) {
    color: var(--color-primary);
  }

  .prose :global(ol li::marker) {
    font-weight: 600;
  }

  /* Code - Inline */
  .prose :global(code) {
    font-family: var(--font-mono);
    font-size: 0.9em;
  }

  .prose :global(p code),
  .prose :global(li code) {
    background: var(--color-surface-elevated);
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    color: var(--color-accent);
  }

  /* Code - Block */
  .prose :global(pre) {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-6);
    margin: var(--space-8) 0;
    overflow-x: auto;
    max-width: 100%;
  }

  .prose :global(pre code) {
    background: transparent;
    padding: 0;
    color: var(--color-text-accent);
    font-size: var(--text-sm);
    line-height: var(--leading-relaxed);
    white-space: pre;
    display: block;
  }

  /* Blockquotes */
  .prose :global(blockquote) {
    position: relative;
    margin: var(--space-10) 0;
    padding: var(--space-6) var(--space-8);
    background: var(--color-surface);
    border-left: 4px solid var(--color-primary);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
  }

  .prose :global(blockquote p) {
    font-style: italic;
    font-size: var(--text-xl);
    color: var(--color-text-secondary);
    margin-bottom: 0;
  }

  .prose :global(blockquote p:last-child) {
    margin-bottom: 0;
  }

  /* Horizontal Rule */
  .prose :global(hr) {
    border: none;
    height: 1px;
    background: var(--color-border);
    margin: var(--space-12) 0;
  }

  /* Tables */
  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: var(--space-8) 0;
    font-size: var(--text-base);
  }

  .prose :global(th),
  .prose :global(td) {
    padding: var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .prose :global(th) {
    font-family: var(--font-ui);
    font-weight: 600;
    text-transform: uppercase;
    font-size: var(--text-xs);
    letter-spacing: var(--tracking-wider);
    color: var(--color-text-muted);
    background: var(--color-surface);
  }

  /* Images in content */
  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--radius-md);
    margin: var(--space-8) 0;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     CONTENT ACTIONS (Text Regeneration)
     ═══════════════════════════════════════════════════════════════════════════ */

  .content-actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .regenerate-text-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text-muted);
    cursor: pointer;
    transition:
      color 0.2s ease,
      background 0.2s ease;
  }

  .regenerate-text-icon:hover {
    color: var(--color-primary);
    background: var(--color-surface-elevated);
    border-color: var(--color-primary);
  }

  .regenerate-text-icon:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .regenerate-text-icon.loading svg {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  .apply-text-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--color-success, #4ade80);
    border: none;
    border-radius: var(--radius-md);
    color: #000;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .apply-text-btn:hover {
    background: #22c55e;
  }

  .apply-text-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .apply-text-btn.loading svg {
    animation: spin 1s linear infinite;
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     SIDEBAR
     ═══════════════════════════════════════════════════════════════════════════ */

  .article-sidebar {
    position: sticky;
    top: calc(var(--header-height) + var(--space-8));
    height: fit-content;
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .sidebar-card {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    border: 1px solid var(--color-border-subtle);
  }

  .sidebar-title {
    font-family: var(--font-ui);
    font-size: var(--text-base);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest);
    color: var(--color-text);
    margin-bottom: var(--space-4);
  }

  .sidebar-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .sidebar-tag {
    font-family: var(--font-ui);
    font-size: var(--text-base);
    color: var(--color-text);
    background: var(--color-surface-elevated);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     ARTICLE FOOTER
     ═══════════════════════════════════════════════════════════════════════════ */

  .article-footer {
    max-width: 1100px;
    margin-top: var(--space-16);
    padding: var(--space-8) 0 var(--space-20);
    border-top: 1px solid var(--color-border);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    color: var(--color-text-secondary);
    text-decoration: none;
    font-family: var(--font-ui);
    font-size: var(--text-sm);
    font-weight: 500;
    transition: color var(--transition-fast);
  }

  .back-link:hover {
    color: var(--color-primary);
  }

  .back-link svg {
    transition: transform var(--transition-fast);
  }

  .back-link:hover svg {
    transform: translateX(-4px);
  }

  /* ═══════════════════════════════════════════════════════════════════════════
     RESPONSIVE
     ═══════════════════════════════════════════════════════════════════════════ */

  @media (max-width: 1024px) {
    .article-body {
      grid-template-columns: 1fr;
      gap: var(--space-10);
    }

    .article-sidebar {
      position: static;
      flex-direction: row;
      flex-wrap: wrap;
    }

    .sidebar-card {
      flex: 1;
      min-width: 200px;
    }
  }

  /* Tablet */
  @media (max-width: 768px) {
    .article-header {
      padding: var(--space-10) 0 var(--space-8);
    }

    .article-lede {
      font-size: var(--text-lg);
    }

    .prose {
      font-size: var(--text-base);
    }

    .prose :global(> p:first-of-type::first-letter) {
      font-size: 3.5em;
    }

    .prose :global(h1) {
      font-size: var(--text-3xl);
    }

    .prose :global(h2) {
      font-size: var(--text-2xl);
    }

    .prose :global(h3) {
      font-size: var(--text-xl);
    }

    .sidebar-card {
      min-width: 100%;
    }
  }

  /* Mobile */
  @media (max-width: 480px) {
    .article-header {
      padding: var(--space-8) 0 var(--space-6);
    }

    .article-meta {
      gap: var(--space-2);
    }

    .article-meta-divider {
      width: 16px;
    }

    .article-lede {
      font-size: var(--text-base);
    }

    .prose :global(> p:first-of-type::first-letter) {
      font-size: 3em;
      padding-right: var(--space-2);
    }

    .prose :global(h1) {
      font-size: var(--text-2xl);
    }

    .prose :global(h2) {
      font-size: var(--text-xl);
      margin-top: var(--space-10);
    }

    .prose :global(h3) {
      font-size: var(--text-lg);
    }

    .prose :global(blockquote) {
      padding: var(--space-4) var(--space-5);
    }

    .prose :global(blockquote p) {
      font-size: var(--text-lg);
    }

    .sidebar-card {
      padding: var(--space-4);
    }

    .article-footer {
      margin-top: var(--space-10);
      padding: var(--space-6) 0 var(--space-12);
    }
  }
</style>
