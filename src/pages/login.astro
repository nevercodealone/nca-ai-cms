---
import Layout from '../layouts/Layout.astro';
import BackLink from '../components/BackLink.astro';

// Redirect if already logged in
const authCookie = Astro.cookies.get('editor-auth');
if (authCookie?.value) {
  const expectedToken = Buffer.from(
    `${process.env.EDITOR_ADMIN}:${process.env.EDITOR_PASSWORD}`
  ).toString('base64');
  if (authCookie.value === expectedToken) {
    return Astro.redirect('/editor');
  }
}
---

<Layout title="Login">
  <div class="login-page">
    <div class="login-container">
      <!-- Decorative element -->
      <div class="login-decoration" aria-hidden="true"></div>

      <div class="login-card animate-fadeInScale">
        <header class="login-header">
          <div class="login-logo">
            <span class="logo-mark">NCA</span>
            <span class="logo-divider"></span>
            <span class="logo-text">Editor</span>
          </div>
          <h1 class="login-title">Willkommen zurück</h1>
          <p class="login-subtitle">Melde dich an, um Artikel zu erstellen</p>
        </header>

        <form id="login-form" class="login-form">
          <div class="field">
            <label for="username">Benutzername</label>
            <input
              type="text"
              id="username"
              name="username"
              required
              autocomplete="username"
              placeholder="Dein Benutzername"
            />
          </div>
          <div class="field">
            <label for="password">Passwort</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              placeholder="Dein Passwort"
            />
          </div>
          <div id="error" class="error" role="alert" aria-live="assertive">
          </div>
          <button type="submit" class="submit-button glow-primary">
            <span class="button-text">Anmelden</span>
            <svg
              class="button-icon"
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </button>
        </form>

        <footer class="login-footer">
          <BackLink href="/" text="Zurück zur Startseite" />
        </footer>
      </div>
    </div>
  </div>
</Layout>

<style>
  .login-page {
    min-height: calc(
      100vh - var(--header-height) - var(--space-12) - var(--space-20)
    );
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-8);
  }

  .login-container {
    position: relative;
    width: 100%;
    max-width: 440px;
  }

  .login-decoration {
    position: absolute;
    top: -100px;
    left: -100px;
    width: 400px;
    height: 400px;
    background: radial-gradient(
      circle at center,
      var(--color-primary-muted) 0%,
      transparent 60%
    );
    opacity: 0.6;
    pointer-events: none;
    z-index: 0;
  }

  .login-card {
    position: relative;
    z-index: 1;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-2xl);
    padding: var(--space-10);
    box-shadow: var(--shadow-xl);
  }

  .login-header {
    text-align: center;
    margin-bottom: var(--space-10);
  }

  .login-logo {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
  }

  .logo-mark {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 700;
    letter-spacing: var(--tracking-tight);
    color: var(--color-text);
  }

  .logo-divider {
    width: 2px;
    height: 24px;
    background: linear-gradient(
      180deg,
      transparent 0%,
      var(--color-primary) 20%,
      var(--color-primary) 80%,
      transparent 100%
    );
  }

  .logo-text {
    font-family: var(--font-ui);
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest);
    color: var(--color-text-muted);
  }

  .login-title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 600;
    letter-spacing: var(--tracking-tight);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .login-subtitle {
    font-family: var(--font-body);
    font-size: var(--text-base);
    color: var(--color-text-muted);
  }

  .login-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  label {
    font-family: var(--font-ui);
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: var(--tracking-widest);
    color: var(--color-text-muted);
  }

  input {
    width: 100%;
    padding: var(--space-4);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-family: var(--font-body);
    font-size: var(--text-base);
    transition:
      border-color var(--transition-fast),
      box-shadow var(--transition-fast);
  }

  input::placeholder {
    color: var(--color-text-muted);
  }

  input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px var(--color-primary-muted);
  }

  .error {
    min-height: var(--space-6);
    padding: 0;
    font-size: var(--text-sm);
    color: var(--color-error);
    text-align: center;
  }

  .error:not(:empty) {
    padding: var(--space-3) var(--space-4);
    background: var(--color-error-muted);
    border-radius: var(--radius-md);
  }

  .submit-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    width: 100%;
    padding: var(--space-4) var(--space-6);
    background: var(--color-primary-dark);
    border: none;
    border-radius: var(--radius-md);
    color: white;
    font-family: var(--font-ui);
    font-size: var(--text-base);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: var(--tracking-wider);
    cursor: pointer;
    transition:
      background var(--transition-fast),
      transform var(--transition-fast),
      box-shadow var(--transition-fast);
    box-shadow: 0 4px 20px rgba(230, 57, 70, 0.3);
  }

  .submit-button:hover {
    background: var(--color-primary-hover);
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(230, 57, 70, 0.4);
  }

  .submit-button:active {
    transform: translateY(0);
  }

  .submit-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .button-icon {
    transition: transform var(--transition-fast);
  }

  .submit-button:hover .button-icon {
    transform: translateX(4px);
  }

  .login-footer {
    margin-top: var(--space-8);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
    text-align: center;
  }

  @media (max-width: 480px) {
    .login-page {
      padding: var(--space-4);
    }

    .login-card {
      padding: var(--space-6);
    }

    .login-title {
      font-size: var(--text-2xl);
    }
  }
</style>

<script>
  const form = document.getElementById('login-form') as HTMLFormElement;
  const errorEl = document.getElementById('error') as HTMLDivElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorEl.textContent = '';

    const formData = new FormData(form);
    const username = formData.get('username');
    const password = formData.get('password');

    const button = form.querySelector('button') as HTMLButtonElement;
    const buttonText = button.querySelector('.button-text') as HTMLSpanElement;
    const buttonIcon = button.querySelector('.button-icon') as SVGElement;

    button.disabled = true;
    buttonText.textContent = 'Anmelden...';
    buttonIcon.style.display = 'none';

    try {
      const response = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Login fehlgeschlagen');
      }

      window.location.href = '/editor';
    } catch (err) {
      errorEl.textContent =
        err instanceof Error ? err.message : 'Login fehlgeschlagen';
      button.disabled = false;
      buttonText.textContent = 'Anmelden';
      buttonIcon.style.display = 'block';
    }
  });
</script>
